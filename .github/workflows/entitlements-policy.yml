name: Verify Pull Request

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true
on:
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Configure Styra CLI
        env:
          STYRA_API_TOKEN: ${{ secrets.ADAMSANDOR_DAS_API_TOKEN }}
          STYRA_CLI_URL: https://adamsandor.svc.styra.com/v1/docs/bin/linux/amd64/styra
        run: |
          curl -s -w "%{http_code}" -H "Authorization: Bearer ${STYRA_API_TOKEN}" -o styra ${STYRA_CLI_URL}
          mv styra /usr/local/bin/styra
          chmod +x /usr/local/bin/styra
          styra configure -i https://adamsandor.svc.styra.com -t ${STYRA_API_TOKEN}
      - name: Replay decision logs
        id: replay
        working-directory: policy
        run: |
          styra validate logreplay -p global/jwt=library/global/jwt/jwt.rego --system=dc105efba51d4f59b419d3979d8ae0e6 -o json > ../replay-result1.json
          styra validate logreplay -p entitlements=system/api/entitlements/entitlements.rego --system=fca9a74811204ea6b1d812f115cede2f -o json > ../replay-result2.json
      - name: Read replay-results 1
        id: replay-results1
        uses: sergeysova/jq-action@v2
        with:
          cmd: 'jq .samples replay-result1.json -r'
      - name: Read replay-results 2
        id: replay-results2
        uses: sergeysova/jq-action@v2
        with:
          cmd: 'jq .samples replay-result2.json -r'
      - name: Add results to PR
        uses: mshick/add-pr-comment@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          message: |
            ## Effects of JWT library change on Gateway policies
            ```json
            ${{ steps.replay-results1.outputs.value }}
            ```
            ## Effects of Entitlements System policy changes
            ```json
            ${{ steps.replay-results2.outputs.value }}
            ```